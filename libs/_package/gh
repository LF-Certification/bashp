# shellcheck shell=bash

# _package::gh
# Downloads and extracts a package from a GitHub release and installs it to the include directory.
#
# Description:
#   This function downloads the latest release of a package from a GitHub repository,
#   extracts it, and installs the specified include file to the appropriate directory.
#   It manages caching of downloaded assets and handles .gitignore updates for the
#   installed functions.
#
# Usage:
#   _package::gh <repository> <include>
#
# Parameters:
#   repository - The GitHub repository in the format "owner/repo"
#   include    - The path to the file to include, in the format "package/function"
#
# Outputs:
#   No direct output, but creates files in the cache directory and include directory.
#   Updates .gitignore if running within a git repository.
#
# Note:
#   Requires curl to be installed.
#   Requires either GH_TOKEN or GITHUB_TOKEN environment variable for GitHub API access.
#   Will create cache directories as needed at BASHP_CACHE_DIR or ~/.cache/bashp.
function _package::gh() {
  local -r repository=${1:-${repository:-?must be set}}
  local -r include=${2:-${include:-?must be set}}

  command -v curl &>/dev/null || return 1

  local -r package=${include%%/*}
  local -r cache="${BASHP_CACHE_DIR:-${HOME}/.cache/bashp}/$repository/$package"

  if [[ ! -f "$cache/$include" ]]; then
    local -r asset="bashp-$package.tar.gz"

    local -r api_response=$(curl -H "Authorization: Bearer ${GH_TOKEN:-${GITHUB_TOKEN}}" -sSf \
      "https://api.github.com/repos/$repository/releases/latest")

    local url
    url=$(echo "$api_response" | grep -o '"url": *"[^"]*"' | grep "assets" | head -1 | cut -d'"' -f4)

    curl -H "Authorization: Bearer ${GH_TOKEN:-${GITHUB_TOKEN}}" \
         -H "Accept: application/octet-stream" -sSfL "$url" -o "$cache/$asset"
    tar -xzf "$cache/$asset" -C "$cache"
  fi

  mkdir -p "$INCLUDE_DIR/$package"
  cp "$cache/$include" "$INCLUDE_DIR/$include"

  if command -v git &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null; then
    local -r function=${include##*/}
    local -r gitignore="$INCLUDE_DIR/$package/.gitignore"
    grep -q "^$function$" "$gitignore" 2>/dev/null || echo "$function" >> "$gitignore"
  fi
}
