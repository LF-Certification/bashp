# shellcheck shell=bash
#
# Copyright 2025 The Linux Foundation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#include file/copy_owners
#include core/test/assert_equals
#include core/test/assert_success
#include core/test/prep_step

function file::tests::copy_owners::test() {
  if ! command -v sudo &>/dev/null; then
    apt-get update -qq && apt-get install -y -qq sudo
  fi

  local sudoCommand=""
  if [[ $EUID -ne 0 ]] && command -v sudo &>/dev/null; then
    sudoCommand="sudo"
  fi

  local sourceFile="/tmp/source_$$"
  local destFile="/tmp/dest_$$"
  
  core::test::prep_step touch "$sourceFile" "$destFile"
  core::test::prep_step $sudoCommand chown root:root "$sourceFile"
  
  core::test::assert_success file::copy_owners "$sourceFile" "$destFile"
  
  local destUser
  destUser=$(stat -c '%U' "$destFile")
  core::test::assert_equals "root" "$destUser"
  
  local destGroup
  destGroup=$(stat -c '%G' "$destFile")
  core::test::assert_equals "root" "$destGroup"
  
  local sourceDir="/tmp/source_dir_$$"
  local destDir="/tmp/dest_dir_$$"
  
  core::test::prep_step mkdir -p "$sourceDir"/{sub1,sub2}
  core::test::prep_step mkdir -p "$destDir"/{sub1,sub2}
  core::test::prep_step touch "$sourceDir"/sub1/file1
  core::test::prep_step touch "$destDir"/sub1/file1
  core::test::prep_step $sudoCommand chown -R root:root "$sourceDir"
  
  core::test::assert_success file::copy_owners "$sourceDir" "$destDir" true
  
  local destDirUser
  destDirUser=$(stat -c '%U' "$destDir")
  core::test::assert_equals "root" "$destDirUser"
  
  local destSubdirUser
  destSubdirUser=$(stat -c '%U' "$destDir/sub1")
  core::test::assert_equals "root" "$destSubdirUser"
  
  local destSubfileUser
  destSubfileUser=$(stat -c '%U' "$destDir/sub1/file1")
  core::test::assert_equals "root" "$destSubfileUser"
  
  local sourceDir2="/tmp/source_dir2_$$"
  local destDir2="/tmp/dest_dir2_$$"
  local currentUser
  currentUser=$(whoami)
  
  core::test::prep_step mkdir -p "$sourceDir2"/{sub1,sub2}
  core::test::prep_step mkdir -p "$destDir2"/{sub1,sub2}
  core::test::prep_step touch "$destDir2"/sub1/file1
  core::test::prep_step $sudoCommand chown -R root:root "$sourceDir2"
  core::test::prep_step $sudoCommand chown "$currentUser:$currentUser" "$destDir2"/sub1/file1
  
  core::test::assert_success file::copy_owners "$sourceDir2" "$destDir2" false
  
  local destDir2User
  destDir2User=$(stat -c '%U' "$destDir2")
  core::test::assert_equals "root" "$destDir2User"
  
  local destSubfile2User
  destSubfile2User=$(stat -c '%U' "$destDir2/sub1/file1")
  core::test::assert_equals "$currentUser" "$destSubfile2User"
  
  local sourceFile2="/tmp/source2_$$"
  local destFile2="/tmp/dest2_$$"
  core::test::prep_step touch "$sourceFile2" "$destFile2"
  core::test::prep_step $sudoCommand chown nobody:nogroup "$sourceFile2" 2>/dev/null || core::test::prep_step $sudoCommand chown nobody:nobody "$sourceFile2"
  
  core::test::assert_success file::copy_owners "$sourceFile2" "$destFile2"
  
  local destFile2User
  destFile2User=$(stat -c '%U' "$destFile2")
  core::test::assert_equals "nobody" "$destFile2User"
}
